<IfModule !ldap_module>
  LoadModule ldap_module modules/mod_ldap.so
</IfModule>
<IfModule !authnz_ldap_module>
  LoadModule authnz_ldap_module modules/mod_authnz_ldap.so
</IfModule>

<IfModule !dav_module>
  LoadModule dav_module modules/mod_dav.so
</IfModule>
<IfModule !dav_fs_module>
  LoadModule dav_fs_module modules/mod_dav_fs.so
</IfModule>
<IfModule !dav_access_module>
  LoadModule dav_access_module modules/mod_dav_access.so
</IfModule>
<IfModule !dav_calendar_module>
  LoadModule dav_calendar_module modules/mod_dav_calendar.so
</IfModule>

<LocationMatch "^/calendar/(?<pmcname>[^/]+)$">
  Dav on
  DavCalendar on
  DavCalendarHome /calendar/%{unescape:%{env:MATCH_PMCNAME}}/
  DavCalendarProvision /calendar/%{unescape:%{env:MATCH_PMCNAME}}/Home/
  DavCalendarTimezone UTC

  <If "%{env:MATCH_PMCNAME} == 'members'>
    <LimitExcept GET PROPFIND>
      AuthType Basic
      AuthName "ASF Members"
      AuthBasicProvider ldap
      authldapurl "ldaps://ldap-us-ro.apache.org:636/ou=people,dc=apache,dc=org?uid"
      AuthLDAPGroupAttribute memberUid
      AuthLDAPGroupAttributeIsDN off
      Require ldap-group cn=member,ou=groups,dc=apache,dc=org
      AuthLDAPMaxSubGroupDepth 0
    </LimitExcept>
  </If>

  <Elseif "%{env:MATCH_PMCNAME} == 'board'>
    <LimitExcept GET PROPFIND>
      <RequireAny>
	<RequireAll>
	  AuthType Basic
	  AuthName "ASF Members"
	  AuthBasicProvider ldap
	  authldapurl "ldaps://ldap-us-ro.apache.org:636/ou=people,dc=apache,dc=org?uid"
	  AuthLDAPGroupAttribute memberUid
	  AuthLDAPGroupAttributeIsDN off
	  Require ldap-group cn=member,ou=groups,dc=apache,dc=org
	  AuthLDAPMaxSubGroupDepth 0
	</RequireAll>
	<RequireAll>
	  AuthType Basic
	  AuthName "ASF Members and Officers"
	  AuthBasicProvider ldap
	  authldapurl "ldaps://ldap-us-ro.apache.org:636/ou=people,dc=apache,dc=org?uid"
	  AuthLDAPGroupAttribute member
	  AuthLDAPGroupAttributeIsDN on
	  Require ldap-group cn=pmc-chairs,ou=groups,ou=services,dc=apache,dc=org
	  AuthLDAPMaxSubGroupDepth 0
	</RequireAll>
      </RequireAny>
    </LimitExcept>
  </Elseif>

  <Else>
    <LimitExcept GET PROPFIND>
      <RequireAny>
	<RequireAll>
	  AuthType Basic
	  AuthName "ASF Members"
	  AuthBasicProvider ldap
	  authldapurl "ldaps://ldap-us-ro.apache.org:636/ou=people,dc=apache,dc=org?uid"
	  AuthLDAPGroupAttribute memberUid
	  AuthLDAPGroupAttributeIsDN off
	  Require ldap-group cn=member,ou=groups,dc=apache,dc=org
	  AuthLDAPMaxSubGroupDepth 0
	</RequireAll>
	<RequireAll>
	  AuthMerging Or
	  AuthType Basic
	  AuthName "ASF member or PMC member"
	  AuthBasicProvider ldap
	  authldapurl "ldaps://ldap-us-ro.apache.org:636/ou=people,dc=apache,dc=org?uid"
	  AuthLDAPGroupAttribute owner
	  AuthLDAPGroupAttributeIsDN on
	  Require ldap-group cn=%{unescape:%{env:MATCH_PMCNAME}},ou=project,ou=groups,dc=apache,dc=org
	  AuthLDAPMaxSubGroupDepth 0
	</RequireAll>
      </RequireAny>
    </LimitExcept>
  </Else>
</LocationMatch>
